{"version":3,"file":"ChartJS.js","sources":["../../../src/client/components/ChartJS.ts"],"sourcesContent":["import { LoadingIcon, decodeData, wait } from \"@vuepress/helper/client\";\nimport { useMutationObserver } from \"@vueuse/core\";\nimport type { Chart, ChartConfiguration } from \"chart.js\";\nimport type { PropType, VNode } from \"vue\";\nimport {\n  computed,\n  defineComponent,\n  h,\n  onMounted,\n  onUnmounted,\n  ref,\n  shallowRef,\n  watch,\n} from \"vue\";\n\nimport { getDarkmodeStatus } from \"../utils/index.js\";\n\nimport \"../styles/chartjs.scss\";\n\ndeclare const MARKDOWN_ENHANCE_DELAY: number;\n\nconst parseChartConfig = (\n  config: string,\n  type: \"js\" | \"json\",\n): ChartConfiguration => {\n  if (type === \"json\") return JSON.parse(config) as ChartConfiguration;\n\n  // eslint-disable-next-line @typescript-eslint/no-implied-eval\n  const runner = new Function(\n    `\\\nlet config,__chart_js_config__;\n{\n${config}\n__chart_js_config__=config;\n}\nreturn __chart_js_config__;\\\n`,\n  ) as () => ChartConfiguration;\n\n  return runner();\n};\n\nexport default defineComponent({\n  name: \"ChartJS\",\n\n  props: {\n    /**\n     * Chart config\n     *\n     * 图表配置\n     */\n    config: {\n      type: String,\n      required: true,\n    },\n\n    /**\n     * Chart id\n     *\n     * 图表 id\n     */\n    id: {\n      type: String,\n      required: true,\n    },\n\n    /**\n     * Chart title\n     *\n     * 图表标题\n     */\n    title: {\n      type: String,\n      default: \"\",\n    },\n\n    /**\n     * Chart config type\n     *\n     * 图表配置类型\n     */\n    type: {\n      type: String as PropType<\"js\" | \"json\">,\n      default: \"json\",\n    },\n  },\n\n  setup(props) {\n    const chartElement = shallowRef<HTMLElement>();\n    const chartCanvasElement = shallowRef<HTMLCanvasElement>();\n\n    const isDarkmode = ref(false);\n    const loading = ref(true);\n\n    const config = computed(() => decodeData(props.config));\n\n    let loaded = false;\n\n    let chartjs: Chart | null;\n\n    const renderChart = async (isDarkmode: boolean): Promise<void> => {\n      const [{ default: ChartJs }] = await Promise.all([\n        import(/* webpackChunkName: \"chart\" */ \"chart.js/auto\"),\n        loaded\n          ? Promise.resolve()\n          : ((loaded = true), wait(MARKDOWN_ENHANCE_DELAY)),\n      ]);\n\n      ChartJs.defaults.borderColor = isDarkmode ? \"#ccc\" : \"#36A2EB\";\n      ChartJs.defaults.color = isDarkmode ? \"#fff\" : \"#000\";\n      ChartJs.defaults.maintainAspectRatio = false;\n\n      const data = parseChartConfig(config.value, props.type);\n      // eslint-disable-next-line @typescript-eslint/no-non-null-assertion\n      const ctx = chartCanvasElement.value!.getContext(\"2d\")!;\n\n      chartjs?.destroy();\n      chartjs = new ChartJs(ctx, data);\n\n      loading.value = false;\n    };\n\n    onMounted(() => {\n      isDarkmode.value = getDarkmodeStatus();\n\n      // Watch darkmode change\n      useMutationObserver(\n        document.documentElement,\n        () => {\n          isDarkmode.value = getDarkmodeStatus();\n        },\n        {\n          attributeFilter: [\"class\", \"data-theme\"],\n          attributes: true,\n        },\n      );\n\n      watch(isDarkmode, (value) => renderChart(value), { immediate: true });\n    });\n\n    onUnmounted(() => {\n      chartjs?.destroy();\n      chartjs = null;\n    });\n\n    return (): (VNode | null)[] => [\n      props.title\n        ? h(\"div\", { class: \"chartjs-title\" }, decodeURIComponent(props.title))\n        : null,\n      loading.value\n        ? h(LoadingIcon, { class: \"chartjs-loading\", height: 192 })\n        : null,\n      h(\n        \"div\",\n        {\n          ref: chartElement,\n          class: \"chartjs-wrapper\",\n          id: props.id,\n          style: {\n            display: loading.value ? \"none\" : \"block\",\n          },\n        },\n        h(\"canvas\", {\n          ref: chartCanvasElement,\n          height: 400,\n        }),\n      ),\n    ];\n  },\n});\n"],"names":["parseChartConfig","config","type","defineComponent","props","chartElement","shallowRef","chartCanvasElement","isDarkmode","ref","loading","computed","decodeData","loaded","chartjs","renderChart","ChartJs","wait","data","ctx","onMounted","getDarkmodeStatus","useMutationObserver","watch","value","onUnmounted","h","LoadingIcon"],"mappings":"sVAqBA,MAAMA,EAAmB,CACvBC,EACAC,IAEIA,IAAS,OAAe,KAAK,MAAMD,CAAM,EAG9B,IAAI,SACjB;AAAA;AAAA,EAGFA,CAAM;AAAA;AAAA;AAAA,4BAKN,EAKF,EAAA,MAAeE,EAAgB,CAC7B,KAAM,UAEN,MAAO,CAML,OAAQ,CACN,KAAM,OACN,SAAU,EACZ,EAOA,GAAI,CACF,KAAM,OACN,SAAU,EACZ,EAOA,MAAO,CACL,KAAM,OACN,QAAS,EACX,EAOA,KAAM,CACJ,KAAM,OACN,QAAS,MACX,CACF,EAEA,MAAMC,EAAO,CACX,MAAMC,EAAeC,EAAwB,EACvCC,EAAqBD,EAAAA,EAErBE,EAAaC,EAAI,EAAK,EACtBC,EAAUD,EAAI,EAAI,EAElBR,EAASU,EAAS,IAAMC,EAAWR,EAAM,MAAM,CAAC,EAEtD,IAAIS,EAAS,GAETC,EAEJ,MAAMC,EAAc,MAAOP,GAAuC,CAChE,KAAM,CAAC,CAAE,QAASQ,CAAQ,CAAC,EAAI,MAAM,QAAQ,IAAI,CAC/C,OAAuC,eAAe,EACtDH,EACI,QAAQ,QAAQ,GACdA,EAAS,GAAOI,EAAK,sBAAsB,EACnD,CAAC,EAEDD,EAAQ,SAAS,YAAcR,EAAa,OAAS,UACrDQ,EAAQ,SAAS,MAAQR,EAAa,OAAS,OAC/CQ,EAAQ,SAAS,oBAAsB,GAEvC,MAAME,EAAOlB,EAAiBC,EAAO,MAAOG,EAAM,IAAI,EAEhDe,EAAMZ,EAAmB,MAAO,WAAW,IAAI,EAErDO,GAAS,QAAQ,EACjBA,EAAU,IAAIE,EAAQG,EAAKD,CAAI,EAE/BR,EAAQ,MAAQ,EAClB,EAEA,OAAAU,EAAU,IAAM,CACdZ,EAAW,MAAQa,EAAkB,EAGrCC,EACE,SAAS,gBACT,IAAM,CACJd,EAAW,MAAQa,EACrB,CAAA,EACA,CACE,gBAAiB,CAAC,QAAS,YAAY,EACvC,WAAY,EACd,CACF,EAEAE,EAAMf,EAAagB,GAAUT,EAAYS,CAAK,EAAG,CAAE,UAAW,EAAK,CAAC,CACtE,CAAC,EAEDC,EAAY,IAAM,CAChBX,GAAS,QACTA,EAAAA,EAAU,IACZ,CAAC,EAEM,IAAwB,CAC7BV,EAAM,MACFsB,EAAE,MAAO,CAAE,MAAO,eAAgB,EAAG,mBAAmBtB,EAAM,KAAK,CAAC,EACpE,KACJM,EAAQ,MACJgB,EAAEC,EAAa,CAAE,MAAO,kBAAmB,OAAQ,GAAI,CAAC,EACxD,KACJD,EACE,MACA,CACE,IAAKrB,EACL,MAAO,kBACP,GAAID,EAAM,GACV,MAAO,CACL,QAASM,EAAQ,MAAQ,OAAS,OACpC,CACF,EACAgB,EAAE,SAAU,CACV,IAAKnB,EACL,OAAQ,GACV,CAAC,CACH,CACF,CACF,CACF,CAAC"}